name: ğŸš¢ CD Pipeline - Continuous Deployment

on:
  # Only run CD when CI passes and code is pushed to main
  workflow_run:
    workflows: ["ğŸš€ CI Pipeline - Learning CI/CD"]
    types:
      - completed
    branches: [ main ]

jobs:
  # Job 1: Deploy to Staging Environment
  deploy-staging:
    name: ğŸ­ Deploy to Staging
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    environment:
      name: staging
      url: https://staging.example.com
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
      
    - name: ğŸ“¦ Download Build Artifact
      uses: actions/download-artifact@v3
      with:
        name: python-app-build
        github-token: ${{ secrets.GITHUB_TOKEN }}
        run-id: ${{ github.event.workflow_run.id }}
        
    - name: ğŸ­ Deploy to Staging
      run: |
        echo "ğŸš€ Deploying to STAGING environment..."
        echo "ğŸ“¦ Extracting build artifact..."
        tar -xzf app-build.tar.gz
        
        echo "ğŸ”§ Setting up staging environment..."
        echo "DATABASE_URL=staging-db.example.com" > .env
        echo "APP_ENV=staging" >> .env
        
        echo "ğŸŒ Starting application on staging..."
        echo "âœ… Staging deployment successful!"
        echo "ğŸ”— Staging URL: https://staging.example.com"
        
    - name: ğŸ§ª Run Smoke Tests on Staging
      run: |
        echo "ğŸ§ª Running smoke tests on staging..."
        echo "âœ… All smoke tests passed!"

  # Job 2: Deploy to Production (with manual approval)
  deploy-production:
    name: ğŸ­ Deploy to Production
    runs-on: ubuntu-latest
    needs: deploy-staging
    environment:
      name: production
      url: https://production.example.com
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
      
    - name: ğŸ“¦ Download Build Artifact
      uses: actions/download-artifact@v3
      with:
        name: python-app-build
        github-token: ${{ secrets.GITHUB_TOKEN }}
        run-id: ${{ github.event.workflow_run.id }}
        
    - name: ğŸ­ Deploy to Production
      run: |
        echo "ğŸš€ Deploying to PRODUCTION environment..."
        echo "ğŸ“¦ Extracting build artifact..."
        tar -xzf app-build.tar.gz
        
        echo "ğŸ”§ Setting up production environment..."
        echo "DATABASE_URL=prod-db.example.com" > .env
        echo "APP_ENV=production" >> .env
        
        echo "ğŸŒ Starting application on production..."
        echo "âœ… Production deployment successful!"
        echo "ğŸ”— Production URL: https://production.example.com"
        
    - name: ğŸ“Š Post-Deployment Health Check
      run: |
        echo "ğŸ¥ Running health checks..."
        echo "âœ… Application is healthy!"
        
    - name: ğŸ”” Notify Team
      run: |
        echo "ğŸ“¢ Notifying team of successful deployment..."
        echo "âœ… Deployment notification sent!"

  # Job 3: Rollback (in case of issues)
  rollback:
    name: âª Rollback Plan
    runs-on: ubuntu-latest
    if: failure()
    
    steps:
    - name: âª Rollback Deployment
      run: |
        echo "ğŸš¨ Deployment failed! Rolling back..."
        echo "âª Restoring previous version..."
        echo "âœ… Rollback completed!"